name: Discover New Certifications

on:
  schedule:
    # Run on the 1st of every month at 3:00 AM UTC
    - cron: '0 3 1 * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  discover:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install aiohttp beautifulsoup4

      - name: Ensure data directory exists
        run: mkdir -p data

      - name: Clean data first
        run: python scripts/clean_data.py

      - name: Discover new certifications
        id: discover
        run: |
          python scripts/discover_certs.py
          if [ -f "data/discoveries.json" ]; then
            COUNT=$(python -c "import json; print(json.load(open('data/discoveries.json'))['count'])")
            echo "count=$COUNT" >> $GITHUB_OUTPUT
          else
            echo "count=0" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.discover.outputs.count > 0
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Add ${{ steps.discover.outputs.count }} newly discovered certifications"
          title: "ðŸŽ“ Add ${{ steps.discover.outputs.count }} New Certifications"
          body: |
            ## Automated Certification Discovery

            This PR was automatically generated by the certification discovery workflow.

            **Discovered:** ${{ steps.discover.outputs.count }} new certifications

            ### What's included:
            - New certification entries discovered from web searches
            - Updated `data/discoveries.json` with discovery details

            ### Review checklist:
            - [ ] Verify certifications are actually free
            - [ ] Verify URLs are correct and accessible
            - [ ] Check for duplicates with existing entries
            - [ ] Ensure categorization is correct

            See `data/NEW_DISCOVERIES.md` for details on each discovery.
          branch: auto/discover-certs
          labels: |
            automation
            new-certs
          delete-branch: true
